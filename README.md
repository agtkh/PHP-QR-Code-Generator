# PHP QR Code Generator

ISO/IEC 18004仕様に準拠した、PHPによるQRコードジェネレータの実装である。

作者: [@agtkh](https://github.com/agtkh)

## 概要

データエンコーディング、リード・ソロモン符号による誤り訂正、マトリックスへの描画、最適なマスクパターンの自動評価など、QRコード生成の主要なプロセスをクラスとして分割し、それぞれの処理を追えるように構成している。

## 基本的な使い方

`index.php`は、GETパラメータを受け付けてQRコード画像を動的に生成するAPIとして動作する。

`http://<your-server>/index.php?{パラメータ}`

### 主なパラメータ

| パラメータ | 説明 | 例 |
| :--- | :--- | :--- |
| `base64` | Base64エンコードされたバイトデータ。最も優先度が高い。 | `?base64=SGVsbG8...` |
| `bytes` | バイト配列（カンマ区切り）。`base64`がない場合に使われる。 | `?bytes=72,101,108,108,111` |
| `text` | QRコードにする文字列。`base64`, `bytes`がない場合に使われる。 | `?text=Hello World` |
| `version` | QRコードのバージョン（サイズ）。1～40。 | `&version=7` |
| `ecl` | 誤り訂正レベル。`L`, `M`, `Q`, `H`のいずれか。 | `&ecl=H` |
| `mask` | マスクパターン。0～7。`auto`または無指定で自動選択。 | `&mask=4` |
| `size` | 生成する画像サイズ（ピクセル）。 | `&size=500` |
| `margin` | 画像の余白（ピクセル）。 | `&margin=40` |

**例:**
```
http://localhost/index.php?text=Hello QR Code!&version=3&ecl=Q
```

## 実装の解説

### ファイル構成

このジェネレータは、以下の主要なファイル（クラス）から構成される。

- **`index.php`**
  GETリクエストを処理し、`QrCodeGenerator`を呼び出すAPIのエントリポイントである。

- **`QrCodeGenerator.php`**
  QRコード生成の全プロセスを管理するコアクラス。コンストラクタで設定を受け取り、`render()`メソッドで最終的な画像リソースを返す。

- **`BitStream.php`**
  ビット単位のデータストリームを扱うためのヘルパークラスである。

- **リード・ソロモン符号の実装** (`ReedSolomonEncoder.php` 他)
  誤り訂正機能を実現するクラス群であり、`GaloisField.php`（ガロア体演算）と`Polynomial.php`（多項式演算）を含む。

### QRコード生成プロセス

`QrCodeGenerator::render()` が呼び出されると、内部では以下の順序で処理が実行される。

1.  **データ分析と容量チェック**: 入力データが必要とするビット長を計算し、指定されたバージョンと誤り訂正レベルの容量内に収まるか検証する。(`validateByteDataCapacity`)
2.  **データコードワードの構築**: モード指示子、文字数指示子を付加し、データをビットストリームに変換後、終端処理とパディングを行い、データコードワード列を生成する。(`buildDataCodewords`)
3.  **誤り訂正コードの生成**: データコードワードを仕様に基づいてブロックに分割し、各ブロックに対してリード・ソロモン符号のアルゴリズムを用いて誤り訂正コードワードを計算する。(`interleaveBlocks`内で`ReedSolomonEncoder`を利用)
4.  **最終メッセージの作成**: データと誤り訂正のコードワードを、仕様書通りにインターリーブ（並べ替え）する。(`interleaveBlocks`)
5.  **マスクパターンの自動選択**: 8種類のマスクパターンをそれぞれ適用したマトリックスを仮生成し、4つのペナルティルールに基づいて評価点を算出。最も点数の低い（読みやすい）パターンを選択する。(`findBestMaskPattern`)
6.  **マトリックス描画**: 最適なマスクパターンを使い、ファインダパターン、アライメントパターン、タイミングパターン、形式情報、バージョン情報、そして最終的なデータビットを順に2次元のマトリックスに配置する。(`generateMatrix`と各種`draw*`メソッド)
7.  **画像生成**: 完成したマトリックスデータ（0と1の配列）を元に、GDライブラリを使ってPNG画像を生成する。(`createImage`)

## 実装範囲

この実装は、QRコードの基本的な構造を理解することに焦点を当てている。現在、以下の機能は実装されていない。

-   **エンコーディングモード**: `BYTE`モードのみ対応している。`NUMERIC`, `ALPHANUMERIC`, `KANJI`モードには対応していない。
-   **構造的連結**: 複数のQRコードにデータを分割する機能には対応していない。

## ライセンス

This project is licensed under the MIT License.
